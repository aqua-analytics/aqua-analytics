import React, { useState, useMemo } from 'react';
import { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { FileText, AlertTriangle, Percent, ListChecks, Search, ChevronUp, ChevronDown } from 'lucide-react';

// --- Mock Data ---
// 제공된 이미지를 기반으로 한 샘플 데이터입니다.
// 실제 환경에서는 서버나 데이터베이스에서 이 데이터를 가져옵니다.

// 시험 항목별 기준값 (이미지 2 참고)
const standards = {
  '포름알데히드': { value: 0.1, unit: 'mg/L' },
  '트리페닐포스핀옥사이드': { value: 1.0, unit: 'ug/L' },
  'N-니트로소디메틸아민': { value: 7.0, unit: 'ng/L' },
  '아크릴로나이트릴': { value: 0.0006, unit: 'mg/L' },
  '안티몬': { value: 0.004, unit: 'mg/L' },
  'N-니트로소디에틸아민': { value: 2.0, unit: 'ng/L' },
  '1-[4-(1-hydroxy-1-methylethyl)phenyl]-ethanone': { value: 200, unit: 'ug/L' },
};

// 전체 시험 데이터 (이미지 1 참고)
const rawSampleData = [
  { id: 1, sampleName: '정수기 모델 A-1', testItem: 'N-니트로소디에틸아민', result: 2.5, sampleDate: '2024-07-10', analyst: '김민준' },
  { id: 2, sampleName: '정수기 모델 B-2', testItem: '포름알데히드', result: 0.08, sampleDate: '2024-07-10', analyst: '이서연' },
  { id: 3, sampleName: '필터 C-X', testItem: '아크릴로나이트릴', result: 0.0007, sampleDate: '2024-07-11', analyst: '박도윤' },
  { id: 4, sampleName: '정수기 모델 A-1', testItem: '트리페닐포스핀옥사이드', result: 0.9, sampleDate: '2024-07-10', analyst: '김민준' },
  { id: 5, sampleName: '저수조 D-5', testItem: 'N-니트로소디메틸아민', result: 8.1, sampleDate: '2024-07-12', analyst: '최아인' },
  { id: 6, sampleName: '필터 C-Y', testItem: 'N-니트로소디에틸아민', result: 1.5, sampleDate: '2024-07-11', analyst: '박도윤' },
  { id: 7, sampleName: '정수기 모델 B-3', testItem: 'N-니트로소디에틸아민', result: 3.0, sampleDate: '2024-07-13', analyst: '이서연' },
  { id: 8, sampleName: '저수조 D-5', testItem: '안티몬', result: 0.005, sampleDate: '2024-07-12', analyst: '최아인' },
  { id: 9, sampleName: '필터 C-X', testItem: '포름알데히드', result: 0.12, sampleDate: '2024-07-11', analyst: '박도윤' },
  { id: 10, sampleName: '정수기 모델 A-2', testItem: 'N-니트로소디에틸아민', result: 4.1, sampleDate: '2024-07-14', analyst: '김민준' },
  { id: 11, sampleName: '정수기 모델 A-1', testItem: 'N-니트로소디메틸아민', result: 1.8, sampleDate: '2024-07-15', analyst: '김민준' },
  { id: 12, sampleName: '필터 C-Z', testItem: '아크릴로나이트릴', result: 0.0005, sampleDate: '2024-07-15', analyst: '박도윤' },
  { id: 13, sampleName: '저수조 E-1', testItem: 'N-니트로소디메틸아민', result: 6.5, sampleDate: '2024-07-16', analyst: '최아인' },
  { id: 14, sampleName: '정수기 모델 B-4', testItem: '트리페닐포스핀옥사이드', result: 1.2, sampleDate: '2024-07-16', analyst: '이서연' },
];

// 데이터 가공: 판정 결과 추가
const processedData = rawSampleData.map(item => {
  const standardInfo = standards[item.testItem];
  const isNonConforming = item.result > standardInfo.value;
  return {
    ...item,
    standardValue: standardInfo.value,
    unit: standardInfo.unit,
    status: isNonConforming ? '부적합' : '적합',
  };
});

// --- 컴포넌트 ---

// A. 핵심 요약 (KPI 카드)
const KpiCard = ({ icon, title, value, color }) => (
  <div className="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4 transition-transform transform hover:scale-105">
    <div className={`p-3 rounded-full ${color}`}>
      {icon}
    </div>
    <div>
      <p className="text-sm text-gray-500">{title}</p>
      <p className="text-2xl font-bold text-gray-800">{value}</p>
    </div>
  </div>
);

// D. 상세 정보 (토글 패널)
const DetailsPanel = ({ selectedSample }) => (
    <div className="bg-white p-6 rounded-xl shadow-md h-full flex flex-col">
        <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">상세 정보</h3>
        {selectedSample ? (
            <div className="space-y-6 flex-grow">
                {/* D-1: 시험 규격 정보 */}
                <div className="bg-gray-50 p-4 rounded-lg">
                    <h4 className="font-semibold text-gray-700 mb-2">D-1: 시험 규격 정보</h4>
                    <p className="text-sm"><span className="font-medium text-gray-600">시험 항목:</span> {selectedSample.testItem}</p>
                    <p className="text-sm"><span className="font-medium text-gray-600">기준값:</span> ≤ {selectedSample.standardValue} {selectedSample.unit}</p>
                    <p className="text-xs text-gray-500 mt-2">관련 규격: 먹는물 수질기준 및 검사 등에 관한 규칙 [별표 1]</p>
                </div>

                {/* D-2: 선택 시료 상세 정보 */}
                <div className="bg-gray-50 p-4 rounded-lg">
                    <h4 className="font-semibold text-gray-700 mb-2">D-2: 선택 시료 상세 정보</h4>
                    <p className="text-sm"><span className="font-medium text-gray-600">시료 번호:</span> {selectedSample.id}</p>
                    <p className="text-sm"><span className="font-medium text-gray-600">시료명:</span> {selectedSample.sampleName}</p>
                    <p className="text-sm"><span className="font-medium text-gray-600">시료 채취일:</span> {selectedSample.sampleDate}</p>
                    <p className="text-sm"><span className="font-medium text-gray-600">분석 담당자:</span> {selectedSample.analyst}</p>
                </div>
            </div>
        ) : (
            <div className="flex-grow flex items-center justify-center text-center">
                <div className="text-gray-500">
                    <ListChecks className="mx-auto h-12 w-12 text-gray-400" />
                    <p className="mt-2">좌측 테이블에서 시료를 선택하면</p>
                    <p>상세 정보가 여기에 표시됩니다.</p>
                </div>
            </div>
        )}
    </div>
);


// C. 전체 시료 데이터 목록 (인터랙티브 테이블)
const DataTable = ({ data, onRowSelect, selectedSampleId }) => {
    const [filter, setFilter] = useState('');
    const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'ascending' });

    const sortedAndFilteredData = useMemo(() => {
        let filteredData = data.filter(item =>
            item.sampleName.toLowerCase().includes(filter.toLowerCase()) ||
            item.testItem.toLowerCase().includes(filter.toLowerCase()) ||
            item.status.toLowerCase().includes(filter.toLowerCase())
        );

        if (sortConfig.key) {
            filteredData.sort((a, b) => {
                if (a[sortConfig.key] < b[sortConfig.key]) {
                    return sortConfig.direction === 'ascending' ? -1 : 1;
                }
                if (a[sortConfig.key] > b[sortConfig.key]) {
                    return sortConfig.direction === 'ascending' ? 1 : -1;
                }
                return 0;
            });
        }

        return filteredData;
    }, [data, filter, sortConfig]);

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
    };

    const getSortIcon = (key) => {
        if (sortConfig.key !== key) {
            return <ChevronUp className="h-4 w-4 text-gray-400 inline-block ml-1" />;
        }
        return sortConfig.direction === 'ascending' ? 
            <ChevronUp className="h-4 w-4 text-gray-800 inline-block ml-1" /> : 
            <ChevronDown className="h-4 w-4 text-gray-800 inline-block ml-1" />;
    };

    const headers = [
        { key: 'id', label: '번호' },
        { key: 'sampleName', label: '시료명' },
        { key: 'testItem', label: '시험항목' },
        { key: 'result', label: '결과' },
        { key: 'standardValue', label: '기준값' },
        { key: 'status', label: '판정' },
    ];

    return (
        <div className="bg-white p-6 rounded-xl shadow-md col-span-1 lg:col-span-2 h-[600px] flex flex-col">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold text-gray-800">C. 전체 시료 데이터 목록</h3>
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                    <input
                        type="text"
                        placeholder="필터 검색..."
                        className="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        value={filter}
                        onChange={(e) => setFilter(e.target.value)}
                    />
                </div>
            </div>
            <div className="flex-grow overflow-y-auto">
                <table className="w-full text-sm text-left text-gray-600">
                    <thead className="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                        <tr>
                            {headers.map(header => (
                                <th key={header.key} scope="col" className="px-6 py-3 cursor-pointer" onClick={() => requestSort(header.key)}>
                                    {header.label} {getSortIcon(header.key)}
                                </th>
                            ))}
                        </tr>
                    </thead>
                    <tbody>
                        {sortedAndFilteredData.map((item) => (
                            <tr
                                key={item.id}
                                className={`border-b hover:bg-gray-100 cursor-pointer 
                                    ${item.status === '부적합' ? 'bg-red-50 text-red-900' : 'bg-white'}
                                    ${selectedSampleId === item.id ? 'ring-2 ring-blue-500' : ''}
                                `}
                                onClick={() => onRowSelect(item)}
                            >
                                <td className="px-6 py-4">{item.id}</td>
                                <td className="px-6 py-4 font-medium">{item.sampleName}</td>
                                <td className="px-6 py-4">{item.testItem}</td>
                                <td className="px-6 py-4 font-bold">{item.result}</td>
                                <td className="px-6 py-4">≤ {item.standardValue}</td>
                                <td className="px-6 py-4">
                                    <span className={`px-2 py-1 rounded-full text-xs font-semibold 
                                        ${item.status === '부적합' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                                        {item.status}
                                    </span>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};


// 메인 대시보드 앱
export default function App() {
    const [selectedSample, setSelectedSample] = useState(null);

    // --- 데이터 분석 로직 ---
    const totalTests = processedData.length;
    const nonConformingTests = processedData.filter(d => d.status === '부적합').length;
    const nonConformingRate = totalTests > 0 ? ((nonConformingTests / totalTests) * 100).toFixed(1) : 0;
    
    // B. 차트 데이터 (이미지 3 참고)
    const nonConformingByItem = useMemo(() => {
        const counts = {};
        processedData.filter(d => d.status === '부적합').forEach(item => {
            counts[item.testItem] = (counts[item.testItem] || 0) + 1;
        });
        return Object.entries(counts).map(([name, value]) => ({ name, value }));
    }, []);

    const nonConformingRateByItem = useMemo(() => {
        const totalCounts = {};
        const nonConformingCounts = {};
        processedData.forEach(item => {
            totalCounts[item.testItem] = (totalCounts[item.testItem] || 0) + 1;
            if (item.status === '부적합') {
                nonConformingCounts[item.testItem] = (nonConformingCounts[item.testItem] || 0) + 1;
            }
        });
        return Object.keys(totalCounts).map(name => ({
            name,
            rate: ((nonConformingCounts[name] || 0) / totalCounts[name] * 100).toFixed(1)
        }));
    }, []);

    const PIE_COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF'];

    const handleRowSelect = (sample) => {
        setSelectedSample(sample);
    };

    return (
        <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            <div className="max-w-screen-2xl mx-auto">
                <header className="mb-6">
                    <h1 className="text-3xl font-bold text-gray-900">시험 분석 결과 대시보드</h1>
                    <p className="text-gray-600 mt-1">데이터 기반의 신속한 부적합 현황 파악 및 관리</p>
                </header>

                {/* A. 핵심 요약 (KPI 카드) */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <KpiCard icon={<ListChecks className="h-6 w-6 text-blue-600"/>} title="총 시험 건수" value={totalTests} color="bg-blue-100"/>
                    <KpiCard icon={<AlertTriangle className="h-6 w-6 text-red-600"/>} title="부적합 건수" value={nonConformingTests} color="bg-red-100"/>
                    <KpiCard icon={<Percent className="h-6 w-6 text-yellow-600"/>} title="부적합 비율" value={`${nonConformingRate}%`} color="bg-yellow-100"/>
                    <KpiCard icon={<FileText className="h-6 w-6 text-green-600"/>} title="처리 대기 파일" value="2" color="bg-green-100"/>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    {/* B. 부적합 현황 통계 (차트) */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">B. 부적합 항목별 분포</h3>
                        <ResponsiveContainer width="100%" height={300}>
                            <PieChart>
                                <Pie data={nonConformingByItem} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={100} label>
                                    {nonConformingByItem.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />
                                    ))}
                                </Pie>
                                <Tooltip formatter={(value) => `${value}건`} />
                                <Legend />
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md">
                         <h3 className="text-xl font-bold text-gray-800 mb-4">B. 부적합 항목별 비율</h3>
                        <ResponsiveContainer width="100%" height={300}>
                            <BarChart data={nonConformingRateByItem} layout="vertical" margin={{ top: 5, right: 20, left: 120, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" />
                                <XAxis type="number" unit="%" />
                                <YAxis dataKey="name" type="category" width={120} />
                                <Tooltip formatter={(value) => `${value}%`} />
                                <Bar dataKey="rate" fill="#8884d8" barSize={20} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* C, D. 데이터 목록 및 상세 정보 */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <DataTable 
                        data={processedData} 
                        onRowSelect={handleRowSelect} 
                        selectedSampleId={selectedSample?.id}
                    />
                    <div className="lg:col-span-1">
                        <DetailsPanel selectedSample={selectedSample} />
                    </div>
                </div>

                <footer className="text-center text-sm text-gray-500 mt-8">
                    <p>자동화 프로세스: 지정된 폴더에 업로드된 엑셀 파일을 자동으로 인덱싱하여 대시보드, 시험성적서, 레포트를 생성합니다.</p>
                    <p>&copy; 2024 Dashboard Design. All rights reserved.</p>
                </footer>
            </div>
        </div>
    );
}
